# Tick Broadcaster - AWS Lambda ะะธะบัะพะฑัะบะตะฝะด

> [๐ฌ๐ง English version](README.md)

## ะะฑะทะพั

Tick Broadcaster โ ััะพ AWS Lambda ะผะธะบัะพะฑัะบะตะฝะด, ะบะพัะพััะน ัะฐะฑะพัะฐะตั ะผะฐะบัะธะผะฐะปัะฝะพ ะฑะปะธะทะบะพ ะบ ะธะณัะพะบะฐะผ ะดะปั ะผะธะฝะธะผะธะทะฐัะธะธ ะทะฐะดะตัะถะบะธ. ะะผะตััะพ ัะพะณะพ ััะพะฑั ะบะปะธะตะฝัั ะฒััะธัะปัะปะธ ัะธะบะธ ะปะพะบะฐะปัะฝะพ, ััะพั ัะตัะฒะธั:

1. **ะะฐะฑะพัะฐะตั ะฒ ะฝะตัะบะพะปัะบะธั AWS ัะตะณะธะพะฝะฐั** (EU, US, Asia ะธ ะดั.)
2. **ะขัะฐะฝัะปะธััะตั ะธะณัะพะฒัะต ัะธะบะธ** ัะตัะตะท WebSocket ะฒัะตะผ ะฟะพะดะบะปัััะฝะฝัะผ ะธะณัะพะบะฐะผ
3. **ะะทะผะตััะตั ะทะฐะดะตัะถะบั ะธะณัะพะบะพะฒ** ะธ ะบะพะฝััะพะปะธััะตั ะฟะพัะพะณะพะฒัะต ะทะฝะฐัะตะฝะธั
4. **ะัะบะปััะฐะตั ะธะณัะพะบะพะฒ** ั ะฟะปะพัะธะผ ะบะฐัะตััะฒะพะผ ัะพะตะดะธะฝะตะฝะธั

## ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         Tick Broadcaster                         โ
โ                    (AWS Lambda ะฒ ะบะฐะถะดะพะผ ัะตะณะธะพะฝะต)                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                   โ
โ  โโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโ          โ
โ  โ  us-east-1  โ    โ  eu-west-1  โ    โ ap-northeast-1โ         โ
โ  โ   Lambda    โ    โ   Lambda    โ    โ    Lambda    โ          โ
โ  โโโโโโโโฌโโโโโโโ    โโโโโโโโฌโโโโโโโ    โโโโโโโโฌโโโโโโโ          โ
โ         โ                  โ                  โ                  โ
โ         โผ                  โผ                  โผ                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ            API Gateway WebSocket API                        โ โ
โ  โ  - $connect: ะะณัะพะบ ะฟะพะดะบะปััะฐะตััั                             โ โ
โ  โ  - $disconnect: ะะณัะพะบ ะพัะบะปััะฐะตััั                           โ โ
โ  โ  - join: ะะณัะพะบ ะฟัะธัะพะตะดะธะฝัะตััั ะบ ัะตััะธะธ                      โ โ
โ  โ  - ping: ะะทะผะตัะตะฝะธะต ะทะฐะดะตัะถะบะธ                                 โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                              โ                                   โ
โ                              โผ                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ                    DynamoDB                                 โ โ
โ  โ  - Sessions: ะะพะฝัะธะณััะฐัะธั ะธะณัะพะฒัั ัะตััะธะน                    โ โ
โ  โ  - Connections: ะะพะดะบะปััะตะฝะธั ะธะณัะพะบะพะฒ + ะทะฐะดะตัะถะบะฐ              โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

        โฒ               โฒ               โฒ
        โ               โ               โ
   WebSocket       WebSocket       WebSocket
        โ               โ               โ
   โโโโโโดโโโโโ    โโโโโโดโโโโโ    โโโโโโดโโโโโ
   โ ะะณัะพะบ   โ    โ ะะณัะพะบ   โ    โ ะะณัะพะบ   โ
   โ   US    โ    โ   EU    โ    โ  Asia   โ
   โโโโโโโโโโโ    โโโโโโโโโโโ    โโโโโโโโโโโ
```

## ะะพัะพะณะพะฒัะต ะทะฝะฐัะตะฝะธั ะทะฐะดะตัะถะบะธ

ะกะธััะตะผะฐ ะบะพะฝััะพะปะธััะตั ะฟะพัะพะณะพะฒัะต ะทะฝะฐัะตะฝะธั ะทะฐะดะตัะถะบะธ ะดะปั ะพะฑะตัะฟะตัะตะฝะธั ัะตััะฝะพะน ะธะณัั:

| ะะฐัะฐะผะตัั | ะะพ ัะผะพะปัะฐะฝะธั | ะะฟะธัะฐะฝะธะต |
|----------|--------------|----------|
| `MAX_LATENCY_MS` | 150ะผั | ะะฐะบัะธะผะฐะปัะฝะฐั ััะตะดะฝัั ะทะฐะดะตัะถะบะฐ ะดะพ ะพัะบะปััะตะฝะธั |
| `MAX_JITTER_MS` | 50ะผั | ะะฐะบัะธะผะฐะปัะฝัะน ะดะถะธััะตั (ััะฐะฝะด. ะพัะบะป.) ะดะพ ะพัะบะปััะตะฝะธั |
| `WARNING_LATENCY_MS` | 100ะผั | ะะพัะพะณ ะทะฐะดะตัะถะบะธ ะดะปั ะฟัะตะดัะฟัะตะถะดะตะฝะธั |
| `WARNING_JITTER_MS` | 30ะผั | ะะพัะพะณ ะดะถะธััะตัะฐ ะดะปั ะฟัะตะดัะฟัะตะถะดะตะฝะธั |
| `LATENCY_SAMPLES` | 5 | ะะพะปะธัะตััะฒะพ ะธะทะผะตัะตะฝะธะน ะดะปั ัััะตะดะฝะตะฝะธั |

### ะะฐะบ ััะพ ัะฐะฑะพัะฐะตั

1. **Ping/Pong**: ะะปะธะตะฝัั ะพัะฟัะฐะฒะปััั `ping` ัะพะพะฑัะตะฝะธั ั ะผะตัะบะพะน ะฒัะตะผะตะฝะธ
2. **ะะฐัััั RTT**: ะกะตัะฒะตั ัะฐัััะธััะฒะฐะตั ะฒัะตะผั ะพะฑัะพะดะฐ
3. **ะกะบะพะปัะทััะตะต ััะตะดะฝะตะต**: ะฃััะตะดะฝััััั ะฟะพัะปะตะดะฝะธะต N ะธะทะผะตัะตะฝะธะน
4. **ะะฐัััั ะดะถะธััะตัะฐ**: ะกัะฐะฝะดะฐััะฝะพะต ะพัะบะปะพะฝะตะฝะธะต ะธะทะผะตัะตะฝะธะน
5. **ะัะพะฒะตัะบะฐ ะฟะพัะพะณะพะฒ**: ะัะธ ะฟัะตะฒััะตะฝะธะธ โ ะฟัะตะดัะฟัะตะถะดะตะฝะธะต ะธะปะธ ะพัะบะปััะตะฝะธะต

### ะกะพััะพัะฝะธั ะธะณัะพะบะฐ

```
connecting โ ready โ playing โ kicked/disconnected
                โ       โ
                โโโโโโโโโ (ะตัะปะธ ะทะฐะดะตัะถะบะฐ ัะปัััะธััั)
```

## ะขะธะฟั ัะพะพะฑัะตะฝะธะน

### ะะปะธะตะฝั โ ะกะตัะฒะตั

```typescript
// ะัะธัะพะตะดะธะฝะธัััั ะบ ะธะณัะพะฒะพะน ัะตััะธะธ
{ "action": "join", "sessionId": "abc-123", "userId": "user_123" }

// Ping ะดะปั ะธะทะผะตัะตะฝะธั ะทะฐะดะตัะถะบะธ
{ "action": "ping", "clientTimestamp": 1703123456789 }
```

### ะกะตัะฒะตั โ ะะปะธะตะฝั

```typescript
// ะะพะดัะฒะตัะถะดะตะฝะธะต ะฟัะธัะพะตะดะธะฝะตะฝะธั ะบ ัะตััะธะธ
{
  "type": "session_joined",
  "sessionId": "abc-123",
  "seed": 987654321,
  "startAt": 1703123456789,
  "tickMs": 100,
  "region": "eu-west-1",
  "wsEndpoint": "wss://xxx.execute-api.eu-west-1.amazonaws.com/prod"
}

// ะะฑัะฐัะฝัะน ะพััััั ะฟะตัะตะด ะฝะฐัะฐะปะพะผ ะธะณัั
{
  "type": "countdown",
  "remainingMs": 2500,
  "startAt": 1703123456789
}

// ะะณัะพะฒะพะน ัะธะบ (ััะฐะฝัะปะธััะตััั ะบะฐะถะดัะต tickMs)
{
  "type": "tick",
  "step": 150,
  "value": 42,
  "round": 2,
  "broken": false,
  "serverTimestamp": 1703123456789
}

// ะัะฒะตั Pong ะดะปั ะธะทะผะตัะตะฝะธั ะทะฐะดะตัะถะบะธ
{
  "type": "pong",
  "clientTimestamp": 1703123456789,
  "serverTimestamp": 1703123456800
}

// ะัะตะดัะฟัะตะถะดะตะฝะธะต ะพ ะทะฐะดะตัะถะบะต
{
  "type": "latency_status",
  "avgLatency": 120,
  "jitter": 35,
  "status": "warning",
  "message": "ะะฑะฝะฐััะถะตะฝะฐ ะฒััะพะบะฐั ะทะฐะดะตัะถะบะฐ"
}

// ะะณัะพะบ ะพัะบะปัััะฝ
{
  "type": "kicked",
  "reason": "ะกัะตะดะฝัั ะทะฐะดะตัะถะบะฐ 180ะผั ะฟัะตะฒััะฐะตั ะผะฐะบัะธะผัะผ 150ะผั",
  "avgLatency": 180,
  "jitter": 45,
  "maxLatency": 150,
  "maxJitter": 50
}
```

## ะะฐะทะฒััััะฒะฐะฝะธะต

### ะขัะตะฑะพะฒะฐะฝะธั

- AWS CLI ะฝะฐัััะพะตะฝ
- Node.js 18+
- Serverless Framework 3.x

### ะะฐะทะฒะตัะฝััั ะฒะพ ะฒัะตั ัะตะณะธะพะฝะฐั

```bash
npm install
npm run build
npm run deploy:all
```

### ะะฐะทะฒะตัะฝััั ะฒ ะบะพะฝะบัะตัะฝะพะผ ัะตะณะธะพะฝะต

```bash
npm run deploy:eu    # EU (ะัะปะฐะฝะดะธั)
npm run deploy:us    # US East (ะกะตะฒะตัะฝะฐั ะะธัะดะถะธะฝะธั)
npm run deploy:asia  # Asia (ะขะพะบะธะพ)
```

## ะะพัะตะผั Lambda ะดะปั ััะฐะฝัะปััะธะธ ัะธะบะพะฒ?

### ะัะตะธะผััะตััะฒะฐ

1. **ะะตะพะณัะฐัะธัะตัะบะพะต ัะฐัะฟัะตะดะตะปะตะฝะธะต**: ะะฐะทะฒััััะฒะฐะฝะธะต ะฒ 20+ AWS ัะตะณะธะพะฝะฐั ะฟะพ ะฒัะตะผั ะผะธัั
2. **ะะฒัะพะผะฐัััะฐะฑะธัะพะฒะฐะฝะธะต**: ะะฑัะฐะฑะฐััะฒะฐะตั ะฟะธะบะธ ะฟะพะดะบะปััะตะฝะธะน ะธะณัะพะบะพะฒ
3. **ะญะบะพะฝะพะผะธัะฝะพััั**: ะะฟะปะฐัะฐ ัะพะปัะบะพ ะทะฐ ะธัะฟะพะปัะทะพะฒะฐะฝะฝะพะต ะฒัะตะผั
4. **ะะธะทะบะฐั ะทะฐะดะตัะถะบะฐ**: Lambda@Edge ัะฐะฑะพัะฐะตั ะฑะปะธะทะบะพ ะบ ะธะณัะพะบะฐะผ

### ะะตะดะพััะฐัะบะธ

1. **ะฅะพะปะพะดะฝัะน ััะฐัั**: ะะตัะฒะพะต ะฟะพะดะบะปััะตะฝะธะต ะผะพะถะตั ะธะผะตัั ะทะฐะดะตัะถะบั ~100ะผั
2. **ะะธะผะธัั WebSocket**: API Gateway WebSocket ะธะผะตะตั ะพะณัะฐะฝะธัะตะฝะธั
3. **ะขะพัะฝะพััั ัะธะบะพะฒ**: ะขะธะบะธ ะผะตะฝะตะต 100ะผั ะผะพะณัั ะธะผะตัั ะดะถะธััะตั

### ะะตัะตะฝะธั

- **Provisioned Concurrency**: ะฃัััะฐะฝัะตั ัะพะปะพะดะฝัะต ััะฐััั
- **ะะฝัััะตะฝะฝะธะน ัะธะบะป ัะธะบะพะฒ**: 25-ัะตะบัะฝะดะฝะฐั Lambda ั ะฒะฝัััะตะฝะฝะธะผ ัะธะบะปะพะผ
- **ะะพัะพะณะธ ะทะฐะดะตัะถะบะธ**: ะัะธะฝะธะผะฐัััั ัะพะปัะบะพ ะธะณัะพะบะธ ั ะฝะธะทะบะพะน ะทะฐะดะตัะถะบะพะน

